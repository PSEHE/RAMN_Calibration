---
title: "Richmond Network Complete Calibration Framework"
author: "Audrey Smith"
date: "5/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(httr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(data.table)
```

# Call in Constituent Functions from Other Scripts
```{r}
source('source_scripts/a_general_purpose_setup.R')
source('source_scripts/b_airnow_api_call.R')
source('source_scripts/c_read_calibrate_filter_aqy_data.R')
source('source_scripts/d_drift_detection.R')
source('source_scripts/e_recalibration.R')
source('source_scripts/f_combine_into_framework.R')
```

#######################################
# Run Gas Calibration
#######################################

```{r}
pollutant <- 'O3'

proxy.data <- get_current_proxy_data(pollutant) %>%
  rename('pollutant_proxy_site'='proxy_site')

aqy.data.raw <- suppressWarnings(read_aqy_data())

aqy.data <- calibrate_O3_data(aqy.data.raw) %>%
  calibrate_NO2_data(.) %>%
  rename_with(.fn = ~str_replace_all(.x, pollutant, 'pollutant'), .cols = everything())

aqy.proxy.data <- inner_join(aqy.data, proxy.data, by = c('pollutant_proxy_site', 'timestamp_pacific'))
```

```{r}
reset_flags(pollutant)

first.timestamp <- min(aqy.proxy.data$timestamp_pacific)

look.back.from.time <- format_timestamp(ymd_hms(first.timestamp) + td_30day)
```


```{r}
while(look.back.from.time < 2021){
  
  print(look.back.from.time)
  
  my.outputs <- detect_drift_recalibrate_data(aqy.proxy.data, aqy.proxy.data.raw, pollutant, look.back.from.time)
  
  aqy.proxy.data <- my.outputs$calibrated_data
  look.back.from.time <- my.outputs$look_back_from_time
  
}
```


#######################################
# Run Particle Calibration
#######################################
```{r}
pollutant <- 'PM25'

proxy.data.PM25 <- get_current_proxy_data('PM25') %>%
  rename('pollutant_proxy_site'='proxy_site')

aqy.data.raw.PM25 <- suppressWarnings(read_aqy_data())

aqy.data.PM25 <- calibrate_PM25_data(aqy.data.raw.PM25) %>%
  rename_with(.fn = ~str_replace_all(.x, pollutant, 'pollutant'), .cols = everything())

aqy.proxy.data.PM25 <- inner_join(aqy.data.PM25, proxy.data.PM25, by = c('pollutant_proxy_site', 'timestamp_pacific'))

mid.month.PM25 <- aqy.proxy.data.PM25 %>%
  mutate(time_month = month(timestamp_pacific), time_day_of_month = as.numeric(str_sub(timestamp_pacific, 9, 10)), 
         time_year = year(timestamp_pacific), .after = 'timestamp_pacific') %>%
  filter(time_day_of_month >= 12 & time_day_of_month <= 18)

monthly.params.PM25 <- generate_new_gain_and_offset_PM25(mid.month.PM25)
```





         































