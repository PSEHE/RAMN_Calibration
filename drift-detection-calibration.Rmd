---
title: "Richmond Network Complete Calibration Framework"
author: "Audrey Smith"
date: "5/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(httr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
```

#Call in Constituent Functions from Other Scripts
```{r}
source('source_scripts/general_purpose_setup.R')
source('source_scripts/airnow_api_call.R')
source('source_scripts/read_calibrate_filter_aqy_data.R')
source('source_scripts/drift_detection.R')
source('source_scripts/recalibration.R')
```

#######################################
# Run Everything
#######################################

```{r}
pollutant <- 'OZONE'

proxy.data <- get_current_proxy_data(pollutant)

aqy.data <- suppressWarnings(read_aqy_data())

aqy.proxy.data.raw <- inner_join(aqy.data, proxy.data, by = 'timestamp_pacific') %>%
  filter(ID %in% c('AQY BB-633', 'AQY BB-642'))

aqy.proxy.data <- calibrate_O3_data(aqy.proxy.data.raw)
```

```{r}
reset_flags(pollutant)

first.timestamp <- min(aqy.proxy.data$timestamp_pacific)

start.time <- format_timestamp(ymd_hms(first.timestamp) + td.30day)
```

```{r}
aqy_proxy_data_72hr <- temporally_filter_data(aqy_proxy_data, start_time, td.72hr)

print(paste('Performing drift detection for', start_time, 'with', nrow(aqy_proxy_data_72hr), 'rows of data'))

new_flags <- get_new_flags(aqy_proxy_data_72hr)

summed_flags <- sum_old_and_new_flags(pollutant, new_flags)

aqys_needing_recal <- get_aqys_needing_recal(summed_flags)

if(length(aqys_needing_recal) < 1){
    
      print('No monitors require recalibration for this 72-hr period')
      
      new_start_time <- format_timestamp(ymd_hms(start_time) + td.hour)
      
      return(list(start_time=new_start_time, full_data=aqy_proxy_data))
  }else{
    
    aqy_proxy_data_30day <- temporally_filter_data(aqy_proxy_data, start_time, td.30day)
    
    new_parameters <- generate_new_gain_and_offset(aqy_proxy_data_30day, aqys_needing_recal, pollutant)
    
    first_flag <- combine_params_get_first_flag(new_parameters, pollutant, start_time)

    new_start_time <- format_timestamp(ymd_hms(first_flag) + td.hour)
    
    reset_flags_if_recalibrated(pollutant)
    
    aqy_proxy_data <- calibrate_O3_data(aqy_proxy_data_raw)
    
    return(list(start_time=new_start_time, full_data=aqy_proxy_data))
  }
  
```

  else
  {aqy.proxy.data <- calibrate_O3_data(aqy.proxy.data.raw) %>%
      calibrate_NO2_data(.)}
```

while(time_to_check < 2021){
  
  print(time_to_check)
  
  time_to_check <- check_drift_calibrate_data(joined_aqy_proxy_data, 'OZONE', format_timestamp(time_to_check))
  
}
```











         































