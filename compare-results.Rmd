---
title: "Compare Results"
author: "Audrey Smith"
date: "6/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, include = FALSE}
library(ggplot2)
library(dplyr)
library(lubridate)
library(stringr)
```

### Prepare Data
```{r}
params_aq <- read.csv("../aeroqual/2021-06/pse_calvals_2021-06.csv")

param_paths_pse_all_O3 <- list.files('results', 'OZONE*', full.names = T)
param_path_pse_current_O3 <- param_paths_pse_all_O3[length(param_paths_pse_all_O3)]
params_pse_O3 <- read.csv(param_path_pse_current_O3)

param_paths_pse_all_NO2 <- list.files('results', 'NO2*', full.names = T)
param_path_pse_current_NO2 <- param_paths_pse_all_NO2[length(param_paths_pse_all_NO2)]
params_pse_NO2 <- read.csv(param_path_pse_current_NO2)

raw_data <- read.csv('raw_data/raw_60_min.csv') %>%
  mutate(Time = as.character(ymd_hms(Time) + 8*60*60))
```

```{r}
data_aq <- inner_join(raw_data, params_aq, by = 'ID') %>%
  filter(Time >= deployment_datetime & Time >= start_date & Time <= end_date) %>%
  dplyr::select(-c(X, deployment_date, deployment_datetime, Longitude, Latitude, year_month)) %>%
  rename_at(.vars = c('PM.gain', 'PM.offset', 'O3.gain', 'O3.offset', 
                      'NO2.a.value', 'NO2.gain', 'NO2.offset', 'Ox.gain', 'Ox.offset'), 
            .funs = ~paste0(.x, '.aq')) %>%
  rename('start.date.aq' = 'start_date', 'end.date.aq'='end_date')
  
data_aq_pse.O3 <- inner_join(data_aq, params_pse_O3, by = 'ID') %>%
  filter(ID %in% c('AQY BB-633', 'AQY BB-642') &
         Time >= deployment_date & Time >= start_date & Time <= end_date &
         O3.gain != 1 & O3.offset != 0) %>%
  dplyr::select(-c(proxy_site, Latitude, Longitude, deployment_date, deployment_datetime)) %>%
  rename('start.date.pse.O3'='start_date', 'end.date.pse.O3'='end_date') %>%
  rename_at(.vars = c('O3.gain', 'O3.offset'), .funs = ~paste0(.x, '.pse'))

data_aq_pse <- inner_join(data_aq_pse.O3, params_pse_NO2, by = 'ID') %>%
  filter(ID %in% c('AQY BB-633', 'AQY BB-642') &
         Time >= deployment_date & Time >= start_date & Time <= end_date &
         NO2.gain != 1 & NO2.offset != 0) %>%
  rename_at(.vars = c('NO2.gain', 'NO2.offset'), .funs = ~paste0(.x, '.pse')) %>%
  rename('start.date.pse.NO2' = 'start_date', 'end.date.pse.NO2'='end_date')
```

```{r}
colnames(data_aq_pse) <- toupper(str_replace_all(colnames(data_aq_pse), '\\_', '\\.'))

data_aq_pse_proxy <- read.csv("results/proxy/NO2_proxy_data.csv") %>%
  filter(proxy_site == 'San Pablo - Rumrill') %>%
  dplyr::select(timestamp_utc, proxy_raw, proxy_site) %>%
  rename('NO2.PROXY' = proxy_raw) %>%
  inner_join(., read.csv("results/proxy/OZONE_proxy_data.csv"), by = c('proxy_site', 'timestamp_utc')) %>%
  rename('TIME'='timestamp_utc') %>%
  inner_join(., data_aq_pse, by = 'TIME') %>%
  rename('O3.PROXY' = proxy_raw) %>%
  filter(TIME < 2021)
```

```{r}
corrected_data <- mutate(data_aq_pse_proxy,
                          TIMESTAMP = ymd_hms(TIME),
                          O3.AQ = O3.GAIN.AQ*(O3.RAW - O3.OFFSET.AQ), 
                          OX.AQ = OX.GAIN.AQ*(OX.RAW - OX.OFFSET.AQ), 
                          NO2.AQ = NO2.GAIN.AQ*(OX.AQ-NO2.A.VALUE.AQ*O3.AQ - NO2.OFFSET.AQ),
                          O3.PSE = O3.GAIN.PSE*O3.RAW + O3.OFFSET.PSE,
                          NO2.PSE = NO2.GAIN.PSE*NO2.RAW + NO2.OFFSET.PSE) %>%
  dplyr::select(c(ID, TIME, TIMESTAMP, LATITUDE, LONGITUDE, DEPLOYMENT.DATE, DEPLOYMENT.DATETIME,
                O3.GAIN.PSE, O3.OFFSET.PSE, O3.GAIN.AQ, O3.OFFSET.AQ,
                O3.PROXY, O3.RAW, O3.PSE, O3.AQ, 
                NO2.GAIN.PSE, NO2.OFFSET.PSE, NO2.GAIN.AQ, NO2.OFFSET.AQ, NO2.A.VALUE.AQ, NO2.RAW,
                NO2.PROXY, NO2.RAW, NO2.PSE, NO2.AQ)) %>%
  mutate(across(where(is.numeric) & !starts_with('L'), ~round(.x, 2)))
```

```{r}
ggplot(data = corrected_data) +
  geom_line(aes(x = NO2.PROXY, y = NO2.PROXY, color = 'perfect fit')) +
  geom_point(aes(x = NO2.PROXY, y = NO2.AQ, color = 'aeroqual'), alpha = .5) +
  geom_point(aes(x = NO2.PROXY, y = NO2.PSE, color = 'PSE'), alpha = .5)
```

### Write Functions to Examine Performance
```{r}
get_timeseries <- function(input_data, aqy_id, month.i){
  
  timeseries_plot <- ggplot(input_data) +
      geom_line(aes(x = TIMESTAMP, y = O3.RAW, color = 'raw')) +
      geom_line(aes(x = TIMESTAMP, y = O3.PROXY, color = 'proxy')) +
      geom_line(aes(x = TIMESTAMP, y = O3.AQ, color = 'aeroqual')) +
      geom_line(aes(x = TIMESTAMP, y = O3.PSE, color = 'pse')) +
      labs(title = paste('Timeseries for', aqy_id, month.i), 
           x = 'Timestamp', y = 'O3 (ppb)') +
      theme(plot.title = element_text(hjust = .5))
  
  print(timeseries_plot)
  
}
```

```{r}
get_error_timeseries <- function(input_data, aqy_id, month.i){
  
  error_timeseries <- input_data %>%
    mutate(AE.RAW = O3.RAW - O3.PROXY, AE.AQ = O3.AQ - O3.PROXY, AE.PSE = O3.PSE - O3.PROXY) %>%
    ggplot() +
    geom_line(aes(x = TIMESTAMP, y = AE.RAW, color = 'raw')) +
    geom_line(aes(x = TIMESTAMP, y = AE.AQ, color = 'aeroqual')) +
    geom_line(aes(x = TIMESTAMP, y = AE.PSE, color = 'pse')) +
    labs(title = paste('Absolute Error for', aqy_id, 'month of', month.i), 
         x = 'Timestamp', y = 'O3_measured - O3_proxy (ppb)') +
    theme(plot.title = element_text(hjust = .5))
  
  print(error_timeseries)
  
}
```

```{r}
get_scatterplot <- function(input_data, aqy_id, month.i){
  
  scatterplot <- ggplot(input_data) +
      geom_line(aes(x = O3.PROXY, y = O3.PROXY, color = '1-to-1 fit')) +
      geom_point(aes(x = O3.PROXY, y = O3.RAW, color = 'raw'), alpha = .5) +
      geom_point(aes(x = O3.PROXY, y = O3.PSE, color = 'pse'), alpha = .5) +
      geom_point(aes(x = O3.PROXY, y = O3.AQ, color = 'aeroqual'), alpha = .5) +
      labs(title = paste('[Proxy] vs [Measured] for', aqy_id, 'month of', month.i), 
           x = 'Timestamp', y = 'O3 (ppb)') +
      theme(plot.title = element_text(hjust = .5))
      
    print(scatterplot)

}
```

```{r}
get_lms <- function(input_data, aqy_id, month.i){
  
  model_raw <- summary(lm('O3.PROXY~O3.RAW', data = input_data))
  model_pse <- summary(lm('O3.PROXY~O3.PSE', data = input_data))
  model_aq <- summary(lm('O3.PROXY~O3.AQ', data = input_data))
  
  r_sq <- data.frame(cbind(month.i, round(model_raw$r.squared, 5), round(model_pse$r.squared, 5), round(model_aq$r.squared, 5)))
  colnames(r_sq) <- c('month', 'raw', 'PSE', 'AQ')
  
  return(r_sq)
}
```

```{r}
get_offset_timeseries <- function(input_data, aqy_id){
  
  offset_timeseries <- ggplot(input_data) +
    geom_line(aes(x = TIMESTAMP, y = O3.OFFSET.PSE, color = 'pse')) +
    geom_line(aes(x = TIMESTAMP, y = O3.OFFSET.AQ, color = 'aeroqual'))  +
    ggtitle(paste('Offset Over Time for', aqy_id)) +
    theme(plot.title = element_text(hjust = .5))
  
  print(offset_timeseries)
}
```

```{r}
get_gain_timeseries <- function(input_data, aqy_id){
  
  gain_timeseries <- ggplot(input_data) +
    geom_line(aes(x = TIMESTAMP, y = O3.GAIN.PSE, color = 'pse')) +
    geom_line(aes(x = TIMESTAMP, y = O3.GAIN.AQ, color = 'aeroqual')) +
    ggtitle(paste('Gain Over Time for', aqy_id)) +
    theme(plot.title = element_text(hjust = .5))
  
  print(gain_timeseries)
  
}
```

```{r}
get_r2_plot <- function(input_data, aqy_id){
  
  r2_plot <- ggplot(input_data) +
    geom_line(aes(x = as.numeric(month), y = as.numeric(AQ), color = 'aeroqual')) +
    geom_line(aes(x = as.numeric(month), y = as.numeric(PSE), color = 'pse')) +
    labs(x = 'Month', y = 'R^2', 
         title = paste('Proxy ~ Measured R^2 Over Time for', aqy_id))  +
    theme(plot.title = element_text(hjust = .5))
  
  print(r2_plot)
}
```

### Run Performance Tests
```{r}
months <- c('07', '08', '09', '10', '11', '12')
```

```{r}
make_all_plots <- function(aqy_id){
  
  monthly_models <- data.frame()
  
  for(month.i in months){
    
    data_for_month <- filter(O3_data, ID == aqy_id & TIME >= paste0('2020-', month.i, '-01 00:00:00') & TIME <= paste0('2020-', month.i, '-31 23:59:59'))
    
    get_timeseries(data_for_month, aqy_id, month.i)
    
    get_error_timeseries(data_for_month, aqy_id, month.i)
    
    get_scatterplot(data_for_month, aqy_id, month.i)
    
    month.i_model <- get_lms(data_for_month, aqy_id, month.i)
    monthly_models <- rbind(monthly_models, month.i_model)
    
  }
  
  data_for_deployment <- filter(O3_data, ID == aqy_id)
  
  overall_model <- get_lms(data_for_deployment, aqy_id, 'Full Deployment')
  all_models <- rbind(overall_model, monthly_models)
  print(all_models)
  
  get_r2_plot(monthly_models, aqy_id)
  
  get_offset_timeseries(data_for_deployment, aqy_id)
  
  get_gain_timeseries(data_for_deployment, aqy_id)
  
}
```

```{r}
make_all_plots('AQY BB-642')
```

```{r}
make_all_plots('AQY BB-633')
```




























